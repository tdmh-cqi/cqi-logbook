<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CQI's Receiving Record</title>
    
    <!-- Tailwind CSS for Styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM (Translators) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel (Translates JSX to JavaScript in the browser) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* Prevents pull-to-refresh on mobile devices when signing */
        body { overscroll-behavior-y: contain; }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- SVG Icons Components ---
        const IconRefresh = ({ className, size = 24 }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>;
        const IconCheckCircle = ({ className, size = 24 }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></svg>;
        const IconAlertCircle = ({ className, size = 24 }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>;
        const IconTrash = ({ className, size = 24 }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>;
        const IconPen = ({ className, size = 24 }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 19l7-7 3 3-7 7-3-3z"/><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/><path d="M2 2l7.586 7.586"/><circle cx="11" cy="11" r="2"/></svg>;
        const IconSend = ({ className, size = 24 }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>;
        const IconFileText = ({ className, size = 24 }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 9H8"/><path d="M16 13H8"/><path d="M16 17H8"/></svg>;

        // ============================================================================
        // CONFIGURATION: PASTE YOUR GOOGLE APPS SCRIPT URL HERE
        // ============================================================================
        const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwpPUIRY-9Um1U335kTF7-4Gr3fiXit4lN5uWOC-UZ2F3kK5HvthKeDVrgOMTxpf8ik/exec";

        const DEFAULT_DEPARTMENTS = [
            "Accounting", "Admin", "Admitting", "CQI", "HR", "IT" // Fallback list
        ];

        // --- Signature Pad Component ---
        const SignaturePad = ({ onReady }) => {
            const canvasRef = useRef(null);
            const [isDrawing, setIsDrawing] = useState(false);

            useEffect(() => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                
                const resizeCanvas = () => {
                    const parent = canvas.parentElement;
                    canvas.width = parent.clientWidth;
                    canvas.height = 200;
                    ctx.lineWidth = 2.5;
                    ctx.lineCap = 'round';
                    ctx.lineJoin = 'round';
                    ctx.strokeStyle = '#0f172a';
                };

                window.addEventListener('resize', resizeCanvas);
                resizeCanvas();

                const preventScroll = (e) => {
                    if (e.target === canvas) e.preventDefault();
                };
                canvas.addEventListener('touchstart', preventScroll, { passive: false });
                canvas.addEventListener('touchmove', preventScroll, { passive: false });

                onReady({
                    clear: () => ctx.clearRect(0, 0, canvas.width, canvas.height),
                    isEmpty: () => {
                        const blank = document.createElement('canvas');
                        blank.width = canvas.width;
                        blank.height = canvas.height;
                        return canvas.toDataURL() === blank.toDataURL();
                    },
                    getData: () => canvas.toDataURL('image/png')
                });

                return () => {
                    window.removeEventListener('resize', resizeCanvas);
                    canvas.removeEventListener('touchstart', preventScroll);
                    canvas.removeEventListener('touchmove', preventScroll);
                };
            }, [onReady]);

            const startDrawing = (e) => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                const rect = canvas.getBoundingClientRect();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                
                ctx.beginPath();
                ctx.moveTo(clientX - rect.left, clientY - rect.top);
                setIsDrawing(true);
            };

            const draw = (e) => {
                if (!isDrawing) return;
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                const rect = canvas.getBoundingClientRect();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                
                ctx.lineTo(clientX - rect.left, clientY - rect.top);
                ctx.stroke();
            };

            const stopDrawing = () => setIsDrawing(false);

            return (
                <div className="relative w-full border-2 border-slate-300 border-dashed rounded-xl overflow-hidden bg-slate-50 shadow-inner hover:border-teal-400 transition-colors">
                    <div className="absolute top-3 left-3 flex items-center gap-2 text-slate-400 pointer-events-none select-none">
                        <IconPen size={16} />
                        <span className="text-sm font-medium">Sign here</span>
                    </div>
                    <canvas
                        ref={canvasRef}
                        onMouseDown={startDrawing}
                        onMouseMove={draw}
                        onMouseUp={stopDrawing}
                        onMouseOut={stopDrawing}
                        onTouchStart={startDrawing}
                        onTouchMove={draw}
                        onTouchEnd={stopDrawing}
                        className="w-full cursor-crosshair touch-none"
                    />
                    <div className="absolute bottom-4 left-4 right-4 border-t border-slate-300 pointer-events-none opacity-50"></div>
                </div>
            );
        };

        // --- Main Application Component ---
        function App() {
            const [departments, setDepartments] = useState(DEFAULT_DEPARTMENTS);
            const [formData, setFormData] = useState({
                department: '',
                date: new Date().toLocaleDateString('en-CA'),
                title: '',
                controlNumber: '',
                receivedByName: ''
            });
            
            const [signaturePadAPI, setSignaturePadAPI] = useState(null);
            const [isSyncing, setIsSyncing] = useState(false);
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [isSuccess, setIsSuccess] = useState(false);
            const [notification, setNotification] = useState({ show: false, type: '', message: '' });

            // Auto-sync on load
            useEffect(() => {
                if (GAS_WEB_APP_URL !== "YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE") {
                    handleSync();
                }
            }, []);

            const showNotification = (type, message) => {
                setNotification({ show: true, type, message });
                setTimeout(() => setNotification({ show: false, type: '', message: '' }), 5000);
            };

            const handleInputChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const clearForm = () => {
                setFormData({
                    department: '',
                    date: new Date().toLocaleDateString('en-CA'),
                    title: '',
                    controlNumber: '',
                    receivedByName: ''
                });
                if (signaturePadAPI) signaturePadAPI.clear();
                setIsSuccess(false);
            };

            const handleSync = async () => {
                if (GAS_WEB_APP_URL === "YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE") return;
                setIsSyncing(true);
                try {
                    const response = await fetch(`${GAS_WEB_APP_URL}?action=getDepartments`);
                    const data = await response.json();
                    if (data.status === 'success' && data.departments && data.departments.length > 0) {
                        setDepartments(data.departments);
                        showNotification('success', 'Departments updated from Sheets!');
                    }
                } catch (error) {
                    console.error('Sync error:', error);
                } finally {
                    setIsSyncing(false);
                }
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                
                if (!formData.department || !formData.date || !formData.title || !formData.receivedByName) {
                    showNotification('error', 'Please fill in all required fields.');
                    return;
                }

                if (!signaturePadAPI || signaturePadAPI.isEmpty()) {
                    showNotification('error', 'Please provide a signature.');
                    return;
                }

                if (GAS_WEB_APP_URL === "YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE") {
                    showNotification('error', 'System is not connected to Google Sheets. Setup Required.');
                    return;
                }

                setIsSubmitting(true);
                
                const payload = {
                    action: 'submitForm',
                    data: {
                        ...formData,
                        signatureBase64: signaturePadAPI.getData().split(',')[1]
                    }
                };

                try {
                    const response = await fetch(GAS_WEB_APP_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify(payload)
                    });
                    
                    const result = await response.json();
                    
                    if (result.status === 'success') {
                        setIsSuccess(true);
                    } else {
                        throw new Error(result.message || 'Submission failed');
                    }
                } catch (error) {
                    console.error('Submit error:', error);
                    showNotification('error', 'Failed to submit data. Please try again.');
                } finally {
                    setIsSubmitting(false);
                }
            };

            if (isSuccess) {
                return (
                    <div className="min-h-screen flex items-center justify-center p-4">
                        <div className="max-w-md w-full bg-white shadow-xl shadow-teal-100/50 rounded-2xl p-8 text-center border border-teal-50">
                            <div className="w-20 h-20 bg-teal-100 rounded-full flex items-center justify-center mx-auto mb-6">
                                <IconCheckCircle size={40} className="text-teal-600" />
                            </div>
                            <h2 className="text-3xl font-bold text-slate-800 mb-2">Thank You!</h2>
                            <p className="text-slate-500 mb-8">The document has been successfully recorded and the signature has been securely saved to the TDMH system.</p>
                            <button onClick={clearForm} className="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-6 rounded-xl transition-all shadow-md active:scale-95 flex items-center justify-center gap-2">
                                <IconFileText size={20} />
                                Record Another Document
                            </button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="py-8 px-4 sm:px-6 lg:px-8 max-w-2xl mx-auto">
                    
                    {/* Header */}
                    <div className="bg-white rounded-t-2xl shadow-sm border-b border-slate-200 p-8 flex flex-col items-center relative">
                        <button onClick={handleSync} disabled={isSyncing} className={`absolute top-4 right-4 flex items-center gap-2 px-3 py-1.5 rounded-lg text-xs font-medium transition-all ${isSyncing ? 'bg-teal-50 text-teal-400 cursor-not-allowed' : 'bg-teal-50 text-teal-700 hover:bg-teal-100 shadow-sm active:scale-95'}`}>
                            <IconRefresh size={14} className={isSyncing ? 'animate-spin' : ''} />
                            {isSyncing ? 'Syncing...' : 'Sync'}
                        </button>

                        <img 
                            src="./images/tdmh-logo.png" 
                            alt="TDMH Logo" 
                            className="h-24 w-auto mb-4 object-contain"
                            onError={(e) => { 
                                e.target.onerror = null; 
                                e.target.src = 'https://via.placeholder.com/150x80/0f766e/ffffff?text=TDMH+Logo'; 
                            }} 
                        />
                        <h1 className="text-2xl sm:text-3xl font-bold text-slate-800 text-center">CQI's Receiving Record</h1>
                        <h2 className="text-sm font-bold text-teal-600 mt-1 uppercase tracking-widest text-center">Continuous Quality Improvement</h2>
                        <p className="text-sm text-slate-500 mt-5 text-center max-w-md">Please fill out the details below and sign to acknowledge receipt.</p>
                    </div>

                    {/* Notifications */}
                    {notification.show && (
                        <div className={`p-4 flex items-center justify-center gap-3 border-x border-b ${notification.type === 'success' ? 'bg-teal-50 text-teal-800 border-teal-200' : 'bg-red-50 text-red-800 border-red-200'}`}>
                            {notification.type === 'success' ? <IconCheckCircle size={20} className="text-teal-600" /> : <IconAlertCircle size={20} className="text-red-600" />}
                            <span className="text-sm font-medium">{notification.message}</span>
                        </div>
                    )}

                    {/* Form */}
                    <div className="bg-white shadow-xl shadow-slate-200/50 rounded-b-2xl p-6 sm:p-8">
                        <form onSubmit={handleSubmit} className="space-y-6">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div className="space-y-2">
                                    <label className="text-sm font-bold text-slate-700 block">Department <span className="text-red-500">*</span></label>
                                    <select name="department" value={formData.department} onChange={handleInputChange} required className="w-full bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-teal-500 focus:border-teal-500 block p-3">
                                        <option value="" disabled>Select Department</option>
                                        {departments.map((dept, i) => <option key={i} value={dept}>{dept}</option>)}
                                    </select>
                                </div>
                                <div className="space-y-2">
                                    <label className="text-sm font-bold text-slate-700 block">Date <span className="text-red-500">*</span></label>
                                    <input type="date" name="date" value={formData.date} readOnly className="w-full bg-slate-100 border border-slate-200 text-slate-500 text-sm rounded-lg block p-3 cursor-not-allowed select-none" />
                                </div>
                            </div>

                            <div className="space-y-2">
                                <label className="text-sm font-bold text-slate-700 block">Title of Document/s <span className="text-red-500">*</span></label>
                                <input type="text" name="title" value={formData.title} onChange={handleInputChange} required placeholder="e.g. Monthly Audit Report" className="w-full bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-teal-500 focus:border-teal-500 block p-3" />
                            </div>

                            <div className="space-y-2">
                                <label className="text-sm font-bold text-slate-700 block">Control Number of Form/s <span className="text-slate-400 font-normal">(Optional)</span></label>
                                <input type="text" name="controlNumber" value={formData.controlNumber} onChange={handleInputChange} placeholder="e.g. TDMH-CQI-F-001-4-0" className="w-full bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-teal-500 focus:border-teal-500 block p-3 uppercase" />
                            </div>

                            <hr className="border-slate-100 my-8" />

                            <div className="space-y-4 bg-teal-50/40 p-6 rounded-xl border border-teal-100">
                                <h3 className="text-lg font-bold text-teal-900 flex items-center gap-2">Receiver Details</h3>
                                <div className="space-y-2 pt-2">
                                    <label className="text-sm font-bold text-slate-700 flex justify-between items-end">
                                        <span>Signature <span className="text-red-500">*</span></span>
                                        <button type="button" onClick={() => signaturePadAPI && signaturePadAPI.clear()} className="text-xs flex items-center gap-1 text-slate-500 hover:text-red-600 transition-colors">
                                            <IconTrash size={12} /> Clear Pad
                                        </button>
                                    </label>
                                    <SignaturePad onReady={setSignaturePadAPI} />
                                </div>
                                <div className="space-y-2 pt-2">
                                    <label className="text-sm font-bold text-slate-700 block">Received by (Full Name) <span className="text-red-500">*</span></label>
                                    <input type="text" name="receivedByName" value={formData.receivedByName} onChange={handleInputChange} required placeholder="Type full name..." className="w-full bg-white border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-teal-500 focus:border-teal-500 block p-3 font-medium" />
                                </div>
                            </div>

                            <div className="pt-4 flex gap-4">
                                <button type="button" onClick={clearForm} className="px-6 py-3 rounded-xl font-bold text-slate-500 bg-slate-100 hover:bg-slate-200 transition-all">Reset</button>
                                <button type="submit" disabled={isSubmitting} className={`flex-1 flex items-center justify-center gap-2 px-6 py-3 rounded-xl font-bold text-white transition-all ${isSubmitting ? 'bg-teal-400 cursor-not-allowed' : 'bg-teal-600 hover:bg-teal-700 shadow-md active:scale-[0.98]'}`}>
                                    {isSubmitting ? <><IconRefresh size={20} className="animate-spin" /> Processing...</> : <><IconSend size={20} /> Submit Record</>}
                                </button>
                            </div>
                        </form>
                    </div>
                    <p className="text-center text-xs text-slate-400 mt-6 font-medium">Securely Integrated with TDMH Workspace</p>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
